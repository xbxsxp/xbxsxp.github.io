<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Segformer | Zhi&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="web前端技术博客,专注web前端学习与总结。JavaScript,js,ES6,TypeScript,vue,React,python,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.5cfcc2a2.css" as="style"><link rel="preload" href="/assets/js/app.e82538dc.js" as="script"><link rel="preload" href="/assets/js/2.9f3745b1.js" as="script"><link rel="preload" href="/assets/js/12.70e9ba0b.js" as="script"><link rel="prefetch" href="/assets/js/10.9d80e932.js"><link rel="prefetch" href="/assets/js/11.60f23d50.js"><link rel="prefetch" href="/assets/js/13.ae3902fb.js"><link rel="prefetch" href="/assets/js/14.115654d0.js"><link rel="prefetch" href="/assets/js/15.6fa762ec.js"><link rel="prefetch" href="/assets/js/16.7aeac9e3.js"><link rel="prefetch" href="/assets/js/17.219680ad.js"><link rel="prefetch" href="/assets/js/18.8dc8d78e.js"><link rel="prefetch" href="/assets/js/19.b89460e8.js"><link rel="prefetch" href="/assets/js/20.322121be.js"><link rel="prefetch" href="/assets/js/21.da5b9e5c.js"><link rel="prefetch" href="/assets/js/22.997fc63d.js"><link rel="prefetch" href="/assets/js/23.774afc7a.js"><link rel="prefetch" href="/assets/js/24.f267b481.js"><link rel="prefetch" href="/assets/js/25.c749188d.js"><link rel="prefetch" href="/assets/js/26.1991796e.js"><link rel="prefetch" href="/assets/js/27.8aad431c.js"><link rel="prefetch" href="/assets/js/28.1749faaf.js"><link rel="prefetch" href="/assets/js/29.166d05c3.js"><link rel="prefetch" href="/assets/js/3.96313516.js"><link rel="prefetch" href="/assets/js/30.6c2a74d3.js"><link rel="prefetch" href="/assets/js/31.795ce508.js"><link rel="prefetch" href="/assets/js/32.b443eb7f.js"><link rel="prefetch" href="/assets/js/33.495aa7cc.js"><link rel="prefetch" href="/assets/js/34.91c6afb6.js"><link rel="prefetch" href="/assets/js/35.0c981a39.js"><link rel="prefetch" href="/assets/js/36.88633bde.js"><link rel="prefetch" href="/assets/js/37.75ca4c26.js"><link rel="prefetch" href="/assets/js/38.aa7f5f8d.js"><link rel="prefetch" href="/assets/js/39.252fb9f5.js"><link rel="prefetch" href="/assets/js/4.66596b60.js"><link rel="prefetch" href="/assets/js/40.81b70e18.js"><link rel="prefetch" href="/assets/js/41.3a314021.js"><link rel="prefetch" href="/assets/js/42.0141df6c.js"><link rel="prefetch" href="/assets/js/43.09866cae.js"><link rel="prefetch" href="/assets/js/44.e0f3255e.js"><link rel="prefetch" href="/assets/js/45.edfeabd5.js"><link rel="prefetch" href="/assets/js/46.8a959ccd.js"><link rel="prefetch" href="/assets/js/47.760cd984.js"><link rel="prefetch" href="/assets/js/48.c5330acc.js"><link rel="prefetch" href="/assets/js/49.1628edfd.js"><link rel="prefetch" href="/assets/js/5.a33ac666.js"><link rel="prefetch" href="/assets/js/50.0cd60347.js"><link rel="prefetch" href="/assets/js/51.9e72684b.js"><link rel="prefetch" href="/assets/js/52.5699ad5b.js"><link rel="prefetch" href="/assets/js/53.3fbe86e9.js"><link rel="prefetch" href="/assets/js/54.d9b5483e.js"><link rel="prefetch" href="/assets/js/55.491b2418.js"><link rel="prefetch" href="/assets/js/56.f7421170.js"><link rel="prefetch" href="/assets/js/57.a3f67905.js"><link rel="prefetch" href="/assets/js/58.0d64dda7.js"><link rel="prefetch" href="/assets/js/59.e5a77c7e.js"><link rel="prefetch" href="/assets/js/6.9d6007cf.js"><link rel="prefetch" href="/assets/js/60.b93afaa2.js"><link rel="prefetch" href="/assets/js/61.f15e1e5d.js"><link rel="prefetch" href="/assets/js/62.7b03baa2.js"><link rel="prefetch" href="/assets/js/63.249ae5e9.js"><link rel="prefetch" href="/assets/js/64.bf09e7dc.js"><link rel="prefetch" href="/assets/js/65.dd252433.js"><link rel="prefetch" href="/assets/js/66.3f9858c7.js"><link rel="prefetch" href="/assets/js/67.e8dcb929.js"><link rel="prefetch" href="/assets/js/68.fb777f86.js"><link rel="prefetch" href="/assets/js/7.e7cc7b39.js"><link rel="prefetch" href="/assets/js/8.4780e49e.js"><link rel="prefetch" href="/assets/js/9.01db72ba.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5cfcc2a2.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="Zhi's blog" class="logo"> <span class="site-name can-hide">Zhi's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/web/" class="nav-link">Leetcode</a></div><div class="nav-item"><a href="/ui/" class="nav-link">Work</a></div><div class="nav-item"><a href="/technology/" class="nav-link">Paper</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://s2.loli.net/2023/05/17/sy9A7TUC4fhamzI.jpg"> <div class="blogger-info"><h3>Xunzhi Xiang</h3> <span></span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/web/" class="nav-link">Leetcode</a></div><div class="nav-item"><a href="/ui/" class="nav-link">Work</a></div><div class="nav-item"><a href="/technology/" class="nav-link">Paper</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>简历内容</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/2d82d8/" class="sidebar-link">对比表示学习</a></li><li><a href="/pages/209084/" class="sidebar-link">图神经网络</a></li><li><a href="/pages/8c2234/" class="sidebar-link">STGCN</a></li><li><a href="/pages/1e74d3/" class="sidebar-link">基础数据增强策略</a></li><li><a href="/pages/809f00/" class="sidebar-link">poseC3D</a></li><li><a href="/pages/c49600/" class="sidebar-link">MAE</a></li><li><a href="/pages/27ee80/" class="sidebar-link">DETR</a></li><li><a href="/pages/531cc3/" aria-current="page" class="active sidebar-link">Segformer</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/531cc3/#_1-分析setr遗留的问题" class="sidebar-link">1 分析SETR遗留的问题</a></li><li class="sidebar-sub-header level2"><a href="/pages/531cc3/#_2-overlap-patch-marging" class="sidebar-link">2 Overlap Patch-marging</a></li><li class="sidebar-sub-header level2"><a href="/pages/531cc3/#_2-mix-ffn" class="sidebar-link">2 Mix-FFN</a></li><li class="sidebar-sub-header level2"><a href="/pages/531cc3/#_3-为什么卷积能进行位置编码" class="sidebar-link">3 为什么卷积能进行位置编码</a></li></ul></li><li><a href="/pages/992c1d/" class="sidebar-link">mseg</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>常规代码复现</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>深度学习八股文</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=Work" title="分类" data-v-06225672>Work</a></li><li data-v-06225672><a href="/categories/?category=%E7%AE%80%E5%8E%86%E5%86%85%E5%AE%B9" title="分类" data-v-06225672>简历内容</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/xiangxunzhi" target="_blank" title="作者" class="beLink" data-v-06225672>xiangxunzhi</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-05-16</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><!---->Segformer<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h2 id="_1-分析setr遗留的问题"><a href="#_1-分析setr遗留的问题" class="header-anchor">#</a> 1 分析SETR遗留的问题</h2> <p>SETR第一个用Vision Transformer做encoder来尝试做语义分割，并且取得了很好的结果， 具体体现为ADE20K上首次刷到50+ mIoU。这其实迈出了比较重要的一步，说明了Transformer在语义分割上潜力很大，使用Transformer的性能上限可以很高。
另一方面，SETR也存在一些问题需要解决。 其中比较主要的问题是SETR采用ViT-large作为encoder, 它有以下几个缺点：</p> <ul><li>ViT-large 参数和计算量非常大，有300M+参数，这对于移动端模型是无法承受的；</li> <li>ViT的结构不太适合做语义分割，因为ViT是柱状结构，全程只能输出固定分辨率的feature map, 比如1/16, 这么低的分辨率对于语义分割不太友好</li> <li>ViT的柱状结构意味着一旦增大输入图片或者缩小patch大小，计算量都会成平方级提高，对显存的负担非常大，32G的V100也可能hold不住</li> <li>位置编码. ViT 用的是固定分辨率的positional embedding, 但是语义分割在测试的时候往往图片的分辨率不是固定的，这时要么对positional embedding做双线性插值，这会损害性能, 要么做固定分辨率的滑动窗口测试，这样效率很低而且很不灵活</li></ul> <p>改进之处:</p> <ul><li>(1) 之前ViT和PVT做patch embedding时，每个patch是独立的，我们这里对patch设计成有overlap的，这样可以保证局部连续性。</li> <li>(2) 彻底去掉了Positional Embedding, 取而代之的是Mix FFN, 即在feed forward network中引入3x3 deepwise conv传递位置信息。</li></ul> <div class="center-container"><p><img src="/assets/img/Segformer.6e2b569c.jpg" alt="在这里插入图片描述"></p></div><h2 id="_2-overlap-patch-marging"><a href="#_2-overlap-patch-marging" class="header-anchor">#</a> 2 Overlap Patch-marging</h2> <p>Segformer在Swin-Transformer的基础上对Patch-marging进行改进，使得不同的Patch有重叠的部分，这样就引入了局部偏置信息</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>class OverlapPatchEmbed<span class="token punctuation">(</span>nn.Module<span class="token punctuation">)</span>:
    <span class="token string">&quot;&quot;</span>&quot; Image to Patch Embedding
    <span class="token string">&quot;&quot;</span>&quot;

    def __init__<span class="token punctuation">(</span>self, <span class="token assign-left variable">img_size</span><span class="token operator">=</span><span class="token number">224</span>, <span class="token assign-left variable">patch_size</span><span class="token operator">=</span><span class="token number">7</span>, <span class="token assign-left variable">stride</span><span class="token operator">=</span><span class="token number">4</span>, <span class="token assign-left variable">in_chans</span><span class="token operator">=</span><span class="token number">3</span>, <span class="token assign-left variable">embed_dim</span><span class="token operator">=</span><span class="token number">768</span><span class="token punctuation">)</span>:
        super<span class="token punctuation">(</span><span class="token punctuation">)</span>.__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        img_size <span class="token operator">=</span> to_2tuple<span class="token punctuation">(</span>img_size<span class="token punctuation">)</span>
        patch_size <span class="token operator">=</span> to_2tuple<span class="token punctuation">(</span>patch_size<span class="token punctuation">)</span>

        self.img_size <span class="token operator">=</span> img_size
        self.patch_size <span class="token operator">=</span> patch_size
        self.H, self.W <span class="token operator">=</span> img_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> // patch_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>, img_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> // patch_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        self.num_patches <span class="token operator">=</span> self.H * self.W
        self.proj <span class="token operator">=</span> nn.Conv2d<span class="token punctuation">(</span>in_chans, embed_dim, <span class="token assign-left variable">kernel_size</span><span class="token operator">=</span>patch_size, <span class="token assign-left variable">stride</span><span class="token operator">=</span>stride,
                              <span class="token assign-left variable">padding</span><span class="token operator">=</span><span class="token punctuation">(</span>patch_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> // <span class="token number">2</span>, patch_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> // <span class="token number">2</span><span class="token punctuation">))</span>
        self.norm <span class="token operator">=</span> nn.LayerNorm<span class="token punctuation">(</span>embed_dim<span class="token punctuation">)</span>

        self.apply<span class="token punctuation">(</span>self._init_weights<span class="token punctuation">)</span>

    def forward<span class="token punctuation">(</span>self, x<span class="token punctuation">)</span>:
        x <span class="token operator">=</span> self.proj<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        _, _, H, W <span class="token operator">=</span> x.shape
        x <span class="token operator">=</span> x.flatten<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>.transpose<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">2</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> self.norm<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        <span class="token builtin class-name">return</span> x, H, W
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h2 id="_2-mix-ffn"><a href="#_2-mix-ffn" class="header-anchor">#</a> 2 Mix-FFN</h2> <p>Mix-FFN, 即在feed forward network中引入 <mjx-container jax="SVG" class="MathJax"><svg xmlns="http://www.w3.org/2000/svg" width="3.557ex" height="1.554ex" viewBox="0 -665 1572 687" style="vertical-align:-0.05ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path></g><g data-mml-node="mi" transform="translate(500, 0)"><path data-c="78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g><g data-mml-node="mn" transform="translate(1072, 0)"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path></g></g></g></svg></mjx-container> deepwise conv传递位置信息。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>class Mlp<span class="token punctuation">(</span>nn.Module<span class="token punctuation">)</span>:
    def __init__<span class="token punctuation">(</span>self, in_features, <span class="token assign-left variable">hidden_features</span><span class="token operator">=</span>None, <span class="token assign-left variable">out_features</span><span class="token operator">=</span>None, <span class="token assign-left variable">act_layer</span><span class="token operator">=</span>nn.GELU, <span class="token assign-left variable">drop</span><span class="token operator">=</span><span class="token number">0</span>.<span class="token punctuation">)</span>:
        super<span class="token punctuation">(</span><span class="token punctuation">)</span>.__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        out_features <span class="token operator">=</span> out_features or in_features
        hidden_features <span class="token operator">=</span> hidden_features or in_features
        self.fc1 <span class="token operator">=</span> nn.Linear<span class="token punctuation">(</span>in_features, hidden_features<span class="token punctuation">)</span>
        self.dwconv <span class="token operator">=</span> DWConv<span class="token punctuation">(</span>hidden_features<span class="token punctuation">)</span>
        self.act <span class="token operator">=</span> act_layer<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self.fc2 <span class="token operator">=</span> nn.Linear<span class="token punctuation">(</span>hidden_features, out_features<span class="token punctuation">)</span>
        self.drop <span class="token operator">=</span> nn.Dropout<span class="token punctuation">(</span>drop<span class="token punctuation">)</span>

        self.apply<span class="token punctuation">(</span>self._init_weights<span class="token punctuation">)</span>

    def _init_weights<span class="token punctuation">(</span>self, m<span class="token punctuation">)</span>:
        <span class="token keyword">if</span> isinstance<span class="token punctuation">(</span>m, nn.Linear<span class="token punctuation">)</span>:
            trunc_normal_<span class="token punctuation">(</span>m.weight, <span class="token assign-left variable">std</span><span class="token operator">=</span>.02<span class="token punctuation">)</span>
            <span class="token keyword">if</span> isinstance<span class="token punctuation">(</span>m, nn.Linear<span class="token punctuation">)</span> and m.bias is not None:
                nn.init.constant_<span class="token punctuation">(</span>m.bias, <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> isinstance<span class="token punctuation">(</span>m, nn.LayerNorm<span class="token punctuation">)</span>:
            nn.init.constant_<span class="token punctuation">(</span>m.bias, <span class="token number">0</span><span class="token punctuation">)</span>
            nn.init.constant_<span class="token punctuation">(</span>m.weight, <span class="token number">1.0</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> isinstance<span class="token punctuation">(</span>m, nn.Conv2d<span class="token punctuation">)</span>:
            fan_out <span class="token operator">=</span> m.kernel_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> * m.kernel_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> * m.out_channels
            fan_out //<span class="token operator">=</span> m.groups
            m.weight.data.normal_<span class="token punctuation">(</span><span class="token number">0</span>, math.sqrt<span class="token punctuation">(</span><span class="token number">2.0</span> / fan_out<span class="token punctuation">))</span>
            <span class="token keyword">if</span> m.bias is not None:
                m.bias.data.zero_<span class="token punctuation">(</span><span class="token punctuation">)</span>

    def forward<span class="token punctuation">(</span>self, x, H, W<span class="token punctuation">)</span>:
        x <span class="token operator">=</span> self.fc1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self.dwconv<span class="token punctuation">(</span>x, H, W<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self.act<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self.drop<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self.fc2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self.drop<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token builtin class-name">return</span> x
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h2 id="_3-为什么卷积能进行位置编码"><a href="#_3-为什么卷积能进行位置编码" class="header-anchor">#</a> 3 为什么卷积能进行位置编码</h2> <p>卷积神经网络是局部滤波器，它在有限的区域内通过调整卷积核参数来提取特征，这意味着卷积滤波器能输出对应某个特征的响应，但是以往的研究对于CNN是否同时也编码了位置信息没有给出证明。在这篇文章中，作者检验了这个假设，揭示了在CNN中编码的绝对位置信息的惊人程度。一组综合性的实验证明了这一假设的有效性，并揭示了在深层CNNs中，位置信息是从何而来，以及如何表达这些信息。</p> <p>文章提出了这么一个假设：位置信息在提取的特征图中是隐式编码的，并且在从视觉场景中分类、检测或分割对象时起着重要的作用。深层神经网络的成功是因为它能学习事物的本质和位置。</p> <div class="center-container"><p><img src="/assets/img/POE.3ddee9fe.jpg" alt="在这里插入图片描述"></p></div><p>作者使用VGG和ResNet结构的网络作为前馈网络(参数冻结)来提取特征，从浅层到深层提取5个leve的特征，然后concat送入Position Encoding Module(该模块开放训练，专注于提取位置信息)。Position Encoding Module的主要目标是验证在分类标签上训练时位置信息是否隐式学习</p> <p>定量实验证明，PosENet（VGG和ResNet）可以很容易地从经过训练的CNN模型中提取位置信息，特别是基于ResNet的PosENet模型。然而，单独训练PosENet（PosENet）直接从图像来预测的得分要低得多。这一结果表明，仅从输入图像中提取位置信息是非常困难的。只有与深度编码网络相耦合，PosENet才能提取出与地面真实位置图一致的位置信息。后续的实验证明了做卷积的zero-padding会在特征途中引入边界和位置信息。</p></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/xugaoyi/vuepress-theme-vdoing/edit/master/docs/02.Work/022.简历内容/09.Segformer.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/27ee80/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">DETR</div></a> <a href="/pages/992c1d/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">mseg</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/27ee80/" class="prev">DETR</a></span> <span class="next"><a href="/pages/992c1d/">mseg</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/42d39a/"><div>
            输入
            <!----></div></a> <span class="date">07-23</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/25c350/"><div>
            数组中第k大的数
            <!----></div></a> <span class="date">07-23</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/e6ee5a/"><div>
            快速排序
            <!----></div></a> <span class="date">07-23</span></dt></dl> <dl><dd></dd> <dt><a href="/archives" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="xiangxunzhi21@mails.ucas.ac.cn" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/xbxsxp" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/playlist?id=7797368436&amp;userid=1660964366" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2023
    <span>Evan Xu | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.e82538dc.js" defer></script><script src="/assets/js/2.9f3745b1.js" defer></script><script src="/assets/js/12.70e9ba0b.js" defer></script>
  </body>
</html>
