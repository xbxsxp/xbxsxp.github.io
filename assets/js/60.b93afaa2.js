(window.webpackJsonp=window.webpackJsonp||[]).push([[60],{414:function(s,t,a){"use strict";a.r(t);var n=a(4),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("class ScaledDotProductAttention"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("nn.Module"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),s._v("' Scaled Dot-Product Attention "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),s._v("'\n\n    def __init__"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self, temperature, "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("attn_dropout")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":\n        super"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(".__init__"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        self.temperature "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" temperature\n        self.dropout "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" nn.Dropout"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("attn_dropout"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n    def forward"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self, q, k, v, "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("mask")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("None"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":\n\n        attn "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" torch.matmul"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("q / self.temperature, k.transpose"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" mask is not None:\n            attn "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" attn.masked_fill"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("mask "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", -1e9"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n        attn "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" self.dropout"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("F.softmax"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("attn, "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dim")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("-1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v("\n        output "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" torch.matmul"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("attn, "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("v")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" output, attn\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("class MultiHeadAttention"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("nn.module"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":\n    def __init__"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self, n_head, d_model, d_k, d_v, dropout "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":\n        super.__init__"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n        self.n_head "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" n_haed\n        self.d_k "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" d_k\n        self.d_v "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" d_v\n        \n        self.w_q "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" nn.Linear"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("d_model, n_head * d_k, bias "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" False"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        self.w_k "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" nn.Linear"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("d_model, n_head * d_k, bias "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" False"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        self.w_v "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" nn.Linear"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("d_model, n_head * d_v, bias "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" False"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n        self.attention "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ScaleDotProductAttention"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("temperature "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" d_k ** "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n        self.dropout "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" dropout\n        self.layer_norm "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" nn.LayerNorm"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("d_model. eps "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 1e-6"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n    def forward"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self, q, k, "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("v")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":\n        d_k, d_v, n_head "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" self.d_k, self.d_v, self.n_head\n        sz_b, len_q, len_k, len_v "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" q.size"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", q.size"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", k.size"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", v.size"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Pass through the pre-attention projection: b x lq x (n*dv)")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Separate different heads: b x lq x n x dv")]),s._v("\n        residual "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" q\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Transpose for attention dot product: b x n x lq x dv")]),s._v("\n        q "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" self.w_q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(".view"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sz_b, len_q, n_head, d_k"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        k "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" self.w_q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(".view"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sz_b, len_k, n_head, d_k"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("v")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" self.w_q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(".view"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sz_b, len_v, n_head, d_v"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n        q, attn "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" self.attention"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("q, k, v, "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("mask")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mask"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#q (sz_b,n_head,N=len_q,d_k)")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#k (sz_b,n_head,N=len_k,d_k)")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#v (sz_b,n_head,N=len_v,d_v)")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Transpose to move the head dimension back: b x lq x n x dv")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Combine the last two dimensions to concatenate all the heads together: b x lq x (n*dv)")]),s._v("\n        q "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" q.transpose"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(".contiguous"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(".view"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sz_b, len_q, -1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#q (sz_b,len_q,n_head,N * d_k)")]),s._v("\n        q "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" self.dropout"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self.fc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v("\n        q "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" residual\n\n        q "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" self.layer_norm"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);